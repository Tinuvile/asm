name: Test Homework Assignments

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-hw1:
    runs-on: ubuntu-latest
    name: Test HW1 (Hello World)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm gcc gdb build-essential
        
    - name: Show tool versions
      run: |
        echo "NASM version:"
        nasm -version
        echo "GCC version:"
        gcc --version
        
    - name: Find assembly file in hw1 directory
      run: |
        echo "Looking for assembly files in hw1/ directory..."
        ASM_FILES=$(find hw1/ -name "*.asm" -type f)
        ASM_COUNT=$(echo "$ASM_FILES" | wc -l)
        
        if [ $ASM_COUNT -eq 0 ]; then
          echo "Error: No .asm files found in hw1/ directory"
          exit 1
        elif [ $ASM_COUNT -gt 1 ]; then
          echo "Warning: Multiple .asm files found in hw1/ directory:"
          echo "$ASM_FILES"
          echo "Will process all files..."
        fi
        
        echo "Found assembly files: $ASM_FILES"
        
    - name: Build and test hw1 programs
      run: |
        echo "================================"
        echo "ğŸ”¨ æ„å»ºå’Œæµ‹è¯• HW1 ç¨‹åº"
        echo "================================"
        
        for ASM_FILE in $(find hw1/ -name "*.asm" -type f); do
          echo ""
          echo "Processing: $ASM_FILE"
          echo "------------------------"
          
          # Extract filename without extension
          BASENAME=$(basename "$ASM_FILE" .asm)
          
          # Build the program
          echo "ğŸ“¦ ç¼–è¯‘ç¨‹åº: $ASM_FILE"
          nasm -f elf64 "$ASM_FILE" -o "hw1/$BASENAME.o"
          ld "hw1/$BASENAME.o" -o "hw1/$BASENAME"
          rm -f "hw1/$BASENAME.o"
          
          echo "âœ… ç¼–è¯‘æˆåŠŸ: hw1/$BASENAME"
          
          # Run the program
          echo "ğŸš€ è¿è¡Œç¨‹åº: hw1/$BASENAME"
          chmod +x "hw1/$BASENAME"
          OUTPUT=$(timeout 10s "./hw1/$BASENAME" 2>&1 || echo "Program finished")
          echo "$OUTPUT"
          
          # Verify Hello World output (if it's hello_world.asm)
          if [[ "$BASENAME" == *"hello"* ]]; then
            if echo "$OUTPUT" | grep -q "Hello"; then
              echo "âœ… Hello World ç¨‹åºè¿è¡Œæ­£å¸¸"
            else
              echo "âŒ Hello World ç¨‹åºè¾“å‡ºå¼‚å¸¸"
              echo "Expected: åŒ…å« 'Hello'"
              echo "Actual: $OUTPUT"
              exit 1
            fi
          fi
          
          echo "âœ… $BASENAME æµ‹è¯•å®Œæˆ"
        done

  test-hw2:
    runs-on: ubuntu-latest
    name: Test HW2 (ASCII Display)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm gcc gdb build-essential
        
    - name: Find assembly file in hw2 directory
      run: |
        echo "Looking for assembly files in hw2/ directory..."
        ASM_FILES=$(find hw2/ -name "*.asm" -type f)
        ASM_COUNT=$(echo "$ASM_FILES" | wc -l)
        
        if [ $ASM_COUNT -eq 0 ]; then
          echo "Error: No .asm files found in hw2/ directory"
          exit 1
        elif [ $ASM_COUNT -gt 1 ]; then
          echo "Warning: Multiple .asm files found in hw2/ directory:"
          echo "$ASM_FILES"
          echo "Will process all files..."
        fi
        
        echo "Found assembly files: $ASM_FILES"
        
    - name: Build and test hw2 programs
      run: |
        echo "================================"
        echo "ğŸ”¨ æ„å»ºå’Œæµ‹è¯• HW2 ç¨‹åº"
        echo "================================"
        
        for ASM_FILE in $(find hw2/ -name "*.asm" -type f); do
          echo ""
          echo "Processing: $ASM_FILE"
          echo "------------------------"
          
          # Extract filename without extension
          BASENAME=$(basename "$ASM_FILE" .asm)
          
          # Build the program
          echo "ğŸ“¦ ç¼–è¯‘ç¨‹åº: $ASM_FILE"
          nasm -f elf64 "$ASM_FILE" -o "hw2/$BASENAME.o"
          ld "hw2/$BASENAME.o" -o "hw2/$BASENAME"
          rm -f "hw2/$BASENAME.o"
          
          echo "âœ… ç¼–è¯‘æˆåŠŸ: hw2/$BASENAME"
          
          # Run the program
          echo "ğŸš€ è¿è¡Œç¨‹åº: hw2/$BASENAME"
          chmod +x "hw2/$BASENAME"
          OUTPUT=$(timeout 10s "./hw2/$BASENAME" 2>&1 || echo "Program finished")
          echo "$OUTPUT"
          
          # Verify ASCII output (if it's ascii.asm)
          if [[ "$BASENAME" == *"ascii"* ]]; then
            if echo "$OUTPUT" | grep -q "abcdefghijklm"; then
              echo "âœ… ASCII ç¨‹åºç¬¬ä¸€è¡Œè¾“å‡ºæ­£ç¡®"
            else
              echo "âŒ ASCII ç¨‹åºç¬¬ä¸€è¡Œè¾“å‡ºå¼‚å¸¸"
              echo "Expected: åŒ…å« 'abcdefghijklm'"
              echo "Actual: $OUTPUT"
              exit 1
            fi
            
            if echo "$OUTPUT" | grep -q "nopqrstuvwxyz"; then
              echo "âœ… ASCII ç¨‹åºç¬¬äºŒè¡Œè¾“å‡ºæ­£ç¡®"
            else
              echo "âŒ ASCII ç¨‹åºç¬¬äºŒè¡Œè¾“å‡ºå¼‚å¸¸"
              echo "Expected: åŒ…å« 'nopqrstuvwxyz'"
              echo "Actual: $OUTPUT"
              exit 1
            fi
            
            echo "âœ… ASCII ç¨‹åºè¾“å‡ºæ ¼å¼éªŒè¯é€šè¿‡"
          fi
          
          echo "âœ… $BASENAME æµ‹è¯•å®Œæˆ"
        done

  test-hw3:
    runs-on: ubuntu-latest
    name: Test HW3 (Sum Calculator)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm gcc gdb build-essential
        
    - name: Find assembly file in hw3 directory
      run: |
        echo "Looking for assembly files in hw3/ directory..."
        ASM_FILES=$(find hw3/ -name "*.asm" -type f)
        ASM_COUNT=$(echo "$ASM_FILES" | wc -l)
        
        if [ $ASM_COUNT -eq 0 ]; then
          echo "Error: No .asm files found in hw3/ directory"
          exit 1
        elif [ $ASM_COUNT -gt 1 ]; then
          echo "Warning: Multiple .asm files found in hw3/ directory:"
          echo "$ASM_FILES"
          echo "Will process all files..."
        fi
        
        echo "Found assembly files: $ASM_FILES"
        
    - name: Build and test hw3 programs
      run: |
        echo "================================"
        echo "ğŸ”¨ æ„å»ºå’Œæµ‹è¯• HW3 ç¨‹åº"
        echo "================================"
        
        for ASM_FILE in $(find hw3/ -name "*.asm" -type f); do
          echo ""
          echo "Processing: $ASM_FILE"
          echo "------------------------"
          
          # Extract filename without extension
          BASENAME=$(basename "$ASM_FILE" .asm)
          
          # Build the program
          echo "ğŸ“¦ ç¼–è¯‘ç¨‹åº: $ASM_FILE"
          nasm -f elf64 "$ASM_FILE" -o "hw3/$BASENAME.o"
          ld "hw3/$BASENAME.o" -o "hw3/$BASENAME"
          rm -f "hw3/$BASENAME.o"
          
          echo "âœ… ç¼–è¯‘æˆåŠŸ: hw3/$BASENAME"
          
          # Test the sum program with input
          echo "ğŸš€ æµ‹è¯•ç¨‹åº: hw3/$BASENAME"
          chmod +x "hw3/$BASENAME"
          
          # Test with input "5" (should calculate 1+2+3+4+5=15)
          echo "æµ‹è¯•è¾“å…¥: 5"
          OUTPUT=$(echo "5" | timeout 10s "./hw3/$BASENAME" 2>&1 || echo "Program finished")
          echo "$OUTPUT"
          
          # Verify sum calculation output
          if [[ "$BASENAME" == *"sum"* ]]; then
            if echo "$OUTPUT" | grep -q "15"; then
              echo "âœ… æ±‚å’Œç¨‹åºè®¡ç®—æ­£ç¡® (5çš„å’Œä¸º15)"
            else
              echo "âŒ æ±‚å’Œç¨‹åºè®¡ç®—ç»“æœå¼‚å¸¸"
              echo "Expected: åŒ…å« '15'"
              echo "Actual: $OUTPUT"
              exit 1
            fi
          fi
          
          echo "âœ… $BASENAME æµ‹è¯•å®Œæˆ"
        done

  test-hw4:
    runs-on: ubuntu-latest
    name: Test HW4 (Multiplication Table)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm gcc gdb build-essential
        
    - name: Find assembly files in hw4 subdirectories
      run: |
        echo "Looking for assembly files in hw4/ subdirectories..."
        ASM_FILES=$(find hw4/ -name "*.asm" -type f)
        ASM_COUNT=$(echo "$ASM_FILES" | wc -l)
        
        if [ $ASM_COUNT -eq 0 ]; then
          echo "Error: No .asm files found in hw4/ directory"
          exit 1
        fi
        
        echo "Found assembly files: $ASM_FILES"
        
    - name: Build and test hw4 programs
      run: |
        echo "================================"
        echo "ğŸ”¨ æ„å»ºå’Œæµ‹è¯• HW4 ç¨‹åº"
        echo "================================"
        
        for ASM_FILE in $(find hw4/ -name "*.asm" -type f); do
          echo ""
          echo "Processing: $ASM_FILE"
          echo "------------------------"
          
          # Extract directory and filename
          DIR=$(dirname "$ASM_FILE")
          BASENAME=$(basename "$ASM_FILE" .asm)
          
          # Build the program
          echo "ğŸ“¦ ç¼–è¯‘ç¨‹åº: $ASM_FILE"
          nasm -f elf64 "$ASM_FILE" -o "$DIR/$BASENAME.o"
          ld "$DIR/$BASENAME.o" -o "$DIR/$BASENAME"
          rm -f "$DIR/$BASENAME.o"
          
          echo "âœ… ç¼–è¯‘æˆåŠŸ: $DIR/$BASENAME"
          
          # Run the program
          echo "ğŸš€ è¿è¡Œç¨‹åº: $DIR/$BASENAME"
          chmod +x "$DIR/$BASENAME"
          OUTPUT=$(timeout 10s "./$DIR/$BASENAME" 2>&1 || echo "Program finished")
          echo "$OUTPUT"
          
          # Verify multiplication table output
          if [[ "$BASENAME" == *"mul99"* ]]; then
            # Check for multiplication table format (1x1=1, 1x2=2, etc.)
            if echo "$OUTPUT" | grep -q "1x1=1" && echo "$OUTPUT" | grep -q "1x2=2" && echo "$OUTPUT" | grep -q "9x9=81"; then
              echo "âœ… ä¹˜æ³•è¡¨ç”Ÿæˆç¨‹åºè¿è¡Œæ­£å¸¸"
            else
              echo "âŒ ä¹˜æ³•è¡¨ç”Ÿæˆç¨‹åºè¾“å‡ºå¼‚å¸¸"
              echo "Expected: åŒ…å«ä¹˜æ³•è¡¨æ ¼å¼ (å¦‚ 1x1=1, 1x2=2, 9x9=81)"
              echo "Actual: $OUTPUT"
              exit 1
            fi
          fi
          
          # Verify table checker output
          if [[ "$BASENAME" == *"check99"* ]]; then
            # Check for error detection format (row col error)
            if echo "$OUTPUT" | grep -q "error"; then
              echo "âœ… ä¹˜æ³•è¡¨æ£€æŸ¥ç¨‹åºæ£€æµ‹åˆ°é”™è¯¯"
            else
              echo "âŒ ä¹˜æ³•è¡¨æ£€æŸ¥ç¨‹åºæœªæ£€æµ‹åˆ°é¢„æœŸé”™è¯¯"
              echo "Expected: åŒ…å« 'error'"
              echo "Actual: $OUTPUT"
              exit 1
            fi
          fi
          
          echo "âœ… $BASENAME æµ‹è¯•å®Œæˆ"
        done

  test-hw6:
    runs-on: ubuntu-latest
    name: Test HW6 (Interrupt Overflow Simulation)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm gcc gdb build-essential
        
    - name: Find assembly file in hw6 directory
      run: |
        echo "Looking for assembly files in hw6/ directory..."
        ASM_FILES=$(find hw6/ -name "*.asm" -type f)
        ASM_COUNT=$(echo "$ASM_FILES" | wc -l)
        
        if [ $ASM_COUNT -eq 0 ]; then
          echo "Error: No .asm files found in hw6/ directory"
          exit 1
        elif [ $ASM_COUNT -gt 1 ]; then
          echo "Warning: Multiple .asm files found in hw6/ directory:"
          echo "$ASM_FILES"
          echo "Will process all files..."
        fi
        
        echo "Found assembly files: $ASM_FILES"
        
    - name: Build and test hw6 programs
      run: |
        echo "================================"
        echo "ğŸ”¨ æ„å»ºå’Œæµ‹è¯• HW6 ç¨‹åº"
        echo "================================"
        
        for ASM_FILE in $(find hw6/ -name "*.asm" -type f); do
          echo ""
          echo "Processing: $ASM_FILE"
          echo "------------------------"
          
          # Extract filename without extension
          BASENAME=$(basename "$ASM_FILE" .asm)
          
          # Build the program
          echo "ğŸ“¦ ç¼–è¯‘ç¨‹åº: $ASM_FILE"
          nasm -f elf64 "$ASM_FILE" -o "hw6/$BASENAME.o"
          ld "hw6/$BASENAME.o" -o "hw6/$BASENAME"
          rm -f "hw6/$BASENAME.o"
          
          echo "âœ… ç¼–è¯‘æˆåŠŸ: hw6/$BASENAME"
          
          # Run the program
          echo "ğŸš€ è¿è¡Œç¨‹åº: hw6/$BASENAME"
          chmod +x "hw6/$BASENAME"
          OUTPUT=$(timeout 10s "./hw6/$BASENAME" 2>&1 || echo "Program finished")
          echo "$OUTPUT"
          
          # Verify interrupt overflow simulation output
          if [[ "$BASENAME" == *"into_sim"* ]]; then
            if echo "$OUTPUT" | grep -q "è§¦å‘ä¸­æ–­" && echo "$OUTPUT" | grep -q "æ£€æµ‹åˆ°æº¢å‡º"; then
              echo "âœ… ä¸­æ–­æº¢å‡ºæ¨¡æ‹Ÿç¨‹åºè¿è¡Œæ­£å¸¸"
            else
              echo "âŒ ä¸­æ–­æº¢å‡ºæ¨¡æ‹Ÿç¨‹åºè¾“å‡ºå¼‚å¸¸"
              echo "Expected: åŒ…å« 'è§¦å‘ä¸­æ–­' å’Œ 'æ£€æµ‹åˆ°æº¢å‡º'"
              echo "Actual: $OUTPUT"
              exit 1
            fi
          fi
          
          echo "âœ… $BASENAME æµ‹è¯•å®Œæˆ"
        done

  summary:
    runs-on: ubuntu-latest
    name: Test Summary
    needs: [test-hw1, test-hw2, test-hw3, test-hw4, test-hw6]
    if: always()
    
    steps:
    - name: Test Results Summary
      run: |
        echo "================================"
        echo "ğŸ“Š ä½œä¸šæµ‹è¯•ç»“æœæ±‡æ€»"
        echo "================================"
        
        HW1_STATUS="${{ needs.test-hw1.result }}"
        HW2_STATUS="${{ needs.test-hw2.result }}"
        HW3_STATUS="${{ needs.test-hw3.result }}"
        HW4_STATUS="${{ needs.test-hw4.result }}"
        HW6_STATUS="${{ needs.test-hw6.result }}"
        
        echo "ğŸ  HW1 (Hello World): $HW1_STATUS"
        echo "ğŸ”¤ HW2 (ASCII Display): $HW2_STATUS"
        echo "ğŸ§® HW3 (Sum Calculator): $HW3_STATUS"
        echo "âœ–ï¸  HW4 (Multiplication Table): $HW4_STATUS"
        echo "âš¡ HW6 (Interrupt Overflow Simulation): $HW6_STATUS"
        echo ""
        
        if [[ "$HW1_STATUS" == "success" && "$HW2_STATUS" == "success" && "$HW3_STATUS" == "success" && "$HW4_STATUS" == "success" && "$HW6_STATUS" == "success" ]]; then
          echo "ğŸ‰ æ‰€æœ‰ä½œä¸šæµ‹è¯•å‡é€šè¿‡ï¼"
          echo "âœ… HW1: Hello World ç¨‹åºæ­£å¸¸è¿è¡Œ"
          echo "âœ… HW2: ASCII å­—ç¬¦æ˜¾ç¤ºç¨‹åºæ­£å¸¸è¿è¡Œ"
          echo "âœ… HW3: æ±‚å’Œè®¡ç®—å™¨ç¨‹åºæ­£å¸¸è¿è¡Œ"
          echo "âœ… HW4: ä¹˜æ³•è¡¨ç¨‹åºæ­£å¸¸è¿è¡Œ"
          echo "âœ… HW6: ä¸­æ–­æº¢å‡ºæ¨¡æ‹Ÿç¨‹åºæ­£å¸¸è¿è¡Œ"
          echo "ğŸš€ æ‰€æœ‰æ±‡ç¼–ç¨‹åºåŠŸèƒ½å®Œæ•´ï¼Œè´¨é‡è‰¯å¥½ï¼"
        else
          echo "âš ï¸  éƒ¨åˆ†æµ‹è¯•æœªé€šè¿‡ï¼Œè¯·æ£€æŸ¥ï¼š"
          if [[ "$HW1_STATUS" != "success" ]]; then
            echo "âŒ HW1 æµ‹è¯•çŠ¶æ€: $HW1_STATUS"
          fi
          if [[ "$HW2_STATUS" != "success" ]]; then
            echo "âŒ HW2 æµ‹è¯•çŠ¶æ€: $HW2_STATUS"
          fi
          if [[ "$HW3_STATUS" != "success" ]]; then
            echo "âŒ HW3 æµ‹è¯•çŠ¶æ€: $HW3_STATUS"
          fi
          if [[ "$HW4_STATUS" != "success" ]]; then
            echo "âŒ HW4 æµ‹è¯•çŠ¶æ€: $HW4_STATUS"
          fi
          if [[ "$HW6_STATUS" != "success" ]]; then
            echo "âŒ HW6 æµ‹è¯•çŠ¶æ€: $HW6_STATUS"
          fi
        fi
        
        echo "================================"
